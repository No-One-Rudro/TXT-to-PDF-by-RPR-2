
/**
 * CHARACTER MASTER v5.0 - Grapheme Cluster Engine
 * Uses modern Intl.Segmenter for perfect Unicode handling (Emojis, Ligatures, Indic Scripts).
 * Fallback to legacy segmentation for older environments.
 */

const COMBINING_CODES = new Set([
  0xFE0F, 0x300, 0x206D, 0x348, 0x1DC4, 0x1DC5, 0x301, 0x200D, 0x302, 0x303, 
  0x304, 0x305, 0x306, 0x307, 0x308, 0x309, 0x30A, 0x30B, 0x30C, 0x30D, 
  0x30E, 0x30F, 0x310, 0x311, 0x312, 0x313, 0x314, 0x315, 0x316, 0x317, 
  0x318, 0x319, 0x31A, 0x31B, 0x31C, 0x31D, 0x31E, 0x31F, 0x320, 0x321, 
  0x322, 0x323, 0x324, 0x325, 0x326, 0x327, 0x328, 0x329, 0x32A, 0x32B, 
  0x32C, 0x32D, 0x32E, 0x32F, 0x330, 0x331, 0x332, 0x333, 0x334, 0x335, 
  0x336, 0x337, 0x338, 0x339, 0x33A, 0x33B, 0x33C, 0x33D, 0x33E, 0x33F, 
  0x340, 0x341, 0x342, 0x343, 0x344, 0x345, 0x346, 0x347, 0x349, 0x34A, 
  0x34B, 0x34C, 0x34D, 0x34E, 0x34F, 0x350, 0x351, 0x352, 0x353, 0x354, 
  0x355, 0x356, 0x357, 0x359, 0x35A, 0x35B, 0x35C, 0x35D, 0x35E, 0x35F, 
  0x360, 0x361, 0x362, 0x363, 0x364, 0x365, 0x366, 0x367, 0x368, 0x369, 
  0x36A, 0x36B, 0x36C, 0x36D, 0x36E, 0x36F, 0x483, 0x484, 0x485, 0x486, 
  0x487, 0x488, 0x489, 0x591, 0x592, 0x593, 0x594, 0x595, 0x596, 0x597, 
  0x598, 0x599, 0x59A, 0x59B, 0x59C, 0x59D, 0x59E, 0x59F, 0x5A0, 0x5A1, 
  0x5A2, 0x5A3, 0x5A4, 0x5A5, 0x5A6, 0x5A7, 0x5A8, 0x5A9, 0x5AA, 0x5AB, 
  0x5AC, 0x5AD, 0x5AE, 0x5AF, 0x5B0, 0x5B1, 0x5B2, 0x5B3, 0x5B4, 0x5B5, 
  0x5B6, 0x5B7, 0x5B8, 0x5B9, 0x5BA, 0x5BB, 0x5BC, 0x5BD, 0x5BF, 0x5C1, 
  0x5C2, 0x5C4, 0x5C5, 0x5C7, 0x610, 0x611, 0x612, 0x613, 0x614, 0x615, 
  0x616, 0x617, 0x618, 0x619, 0x61A, 0x64B, 0x64C, 0x64D, 0x64E, 0x64F, 
  0x650, 0x651, 0x652, 0x653, 0x654, 0x655, 0x656, 0x657, 0x658, 0x659, 
  0x65A, 0x65B, 0x65C, 0x65D, 0x65E, 0x65F, 0x670, 0x6D6, 0x6D7, 0x6D8, 
  0x6D9, 0x6DA, 0x6DB, 0x6DC, 0x6DF, 0x6E0, 0x6E1, 0x6E2, 0x6E3, 0x6E4, 
  0x6E7, 0x6E8, 0x6EA, 0x6EB, 0x6EC, 0x6ED, 0x711, 0x730, 0x731, 0x732, 
  0x733, 0x734, 0x735, 0x736, 0x737, 0x738, 0x739, 0x73A, 0x73B, 0x73C, 
  0x73D, 0x73E, 0x73F, 0x740, 0x741, 0x742, 0x743, 0x744, 0x745, 0x746, 
  0x747, 0x748, 0x749, 0x74A, 0x7A6, 0x7A7, 0x7A8, 0x7A9, 0x7AA, 0x7AB, 
  0x7AC, 0x7AD, 0x7AE, 0x7AF, 0x7B0, 0x7EB, 0x7EC, 0x7ED, 0x7EE, 0x7EF, 
  0x7F0, 0x7F1, 0x7F2, 0x7F3, 0x816, 0x817, 0x818, 0x819, 0x81B, 0x81C, 
  0x81D, 0x81E, 0x81F, 0x820, 0x821, 0x822, 0x823, 0x825, 0x826, 0x827, 
  0x829, 0x82A, 0x82B, 0x82C, 0x82D, 0x858, 0x859, 0x85A, 0x85B, 0x8E4, 
  0x8E5, 0x8E6, 0x8E7, 0x8E8, 0x8E9, 0x8EA, 0x8EB, 0x8EC, 0x8ED, 0x8EE, 
  0x8EF, 0x8F0, 0x8F1, 0x8F2, 0x8F3, 0x8F4, 0x8F5, 0x8F6, 0x8F7, 0x8F8, 
  0x8F9, 0x8FA, 0x8FB, 0x8FC, 0x8FD, 0x8FE, 0x951, 0x952, 0x953, 0x954, 
  0xE31, 0xE34, 0xE35, 0xE36, 0xE37, 0xE38, 0xE39, 0xE3A, 0xE47, 0xE48, 
  0xE49, 0xE4A, 0xE4B, 0xE4C, 0xE4D, 0xE4E, 0xEB1, 0xEB4, 0xEB5, 0xEB6, 
  0xEB7, 0xEB8, 0xEB9, 0xEBB, 0xEBC, 0xEC8, 0xEC9, 0xECA, 0xECB, 0xECC, 
  0xECD, 0x135D, 0x135E, 0x135F, 0x1712, 0x1713, 0x1714, 0x1732, 0x1733, 
  0x1752, 0x1753, 0x1772, 0x1773, 0x17B4, 0x17B5, 0x180B, 0x180C, 0x180D, 
  0x1920, 0x1921, 0x1922, 0x1927, 0x1928, 0x192A, 0x1932, 0x1939, 0x193A, 
  0x193B, 0x1A17, 0x1A18, 0x1A1B, 0x1A55, 0x1A56, 0x1A58, 0x1A59, 0x1A5A, 
  0x1A5B, 0x1A5C, 0x1A5D, 0x1A5E, 0x1A60, 0x1A62, 0x1A65, 0x1A66, 0x1A67, 
  0x1A68, 0x1A69, 0x1A6A, 0x1A6B, 0x1A6C, 0x1A73, 0x1A74, 0x1A75, 0x1A76, 
  0x1A77, 0x1A78, 0x1A79, 0x1A7A, 0x1A7B, 0x1A7C, 0x1A7F, 0x1AB0, 0x1AB1, 
  0x1AB2, 0x1AB3, 0x1AB4, 0x1AB5, 0x1AB6, 0x1AB7, 0x1AB8, 0x1AB9, 0x1ABA, 
  0x1ABB, 0x1ABC, 0x1ABD, 0x1ABE, 0x1B80, 0x1B81, 0x1BA1, 0x1BA2, 0x1BA3, 
  0x1BA4, 0x1BA5, 0x1BA8, 0x1BA9, 0x1BAB, 0x1BAC, 0x1BAD, 0x1BE6, 0x1BE8, 
  0x1BE9, 0x1BED, 0x1BEE, 0x1BEF, 0x1BF0, 0x1BF1, 0x1C2C, 0x1C2D, 0x1C2E, 
  0x1C2F, 0x1C30, 0x1C31, 0x1C32, 0x1C33, 0x1C36, 0x1C37, 0x1CD0, 0x1CD2, 
  0x1CD5, 0x1CD6, 0x1CD7, 0x1CD8, 0x1CD9, 0x1CDA, 0x1CDC, 0x1CDD, 0x1CED, 
  0x1CF4, 0x1CF8, 0x1CF9, 0x1DC0, 0x1DC1, 0x1DC2, 0x1DC3, 0x1DC6, 0x1DC7, 
  0x1DC8, 0x1DC9, 0x1DCA, 0x1DCB, 0x1DCC, 0x1DCD, 0x1DCE, 0x1DCF, 0x1DD0, 
  0x1DD1, 0x1DD2, 0x1DD3, 0x1DD4, 0x1DD5, 0x1DD6, 0x1DD7, 0x1DD8, 0x1DD9, 
  0x1DDA, 0x1DDB, 0x1DDC, 0x1DDD, 0x1DDE, 0x1DDF, 0x1DE0, 0x1DE1, 0x1DE2, 
  0x1DE3, 0x1DE4, 0x1DE5, 0x1DE6, 0x1DE7, 0x1DE8, 0x1DE9, 0x1DEA, 0x1DEB, 
  0x1DEC, 0x1DED, 0x1DEE, 0x1DEF, 0x1DF0, 0x1DF1, 0x1DF2, 0x1DF3, 0x1DF4, 
  0x1DF5, 0x1DFC, 0x1DFD, 0x1DFE, 0x1DFF, 0x20D0, 0x20D1, 0x20D2, 0x20D3, 
  0x20D4, 0x20D5, 0x20D6, 0x20D7, 0x20D8, 0x20D9, 0x20DA, 0x20DB, 0x20DC, 
  0x20DD, 0x20DE, 0x20DF, 0x20E1, 0x20E2, 0x20E5, 0x20E6, 0x20E7, 0x20E8, 
  0x20E9, 0x20EA, 0x20EB, 0x20EC, 0x20ED, 0x20EE, 0x20EF, 0x20F0, 0x2CEF, 
  0x2CF0, 0x2CF1, 0x2D7F, 0x2DE0, 0x2DE1, 0x2DE2, 0x2DE3, 0x2DE4, 0x2DE5, 
  0x2DE6, 0x2DE7, 0x2DE8, 0x2DE9, 0x2DEA, 0x2DEB, 0x2DEC, 0x2DED, 0x2DEE, 
  0x2DEF, 0x2DF0, 0x2DF1, 0x2DF2, 0x2DF3, 0x2DF4, 0x2DF5, 0x2DF6, 0x2DF7, 
  0x2DF8, 0x2DF9, 0x2DFA, 0x2DFB, 0x2DFC, 0x2DFD, 0x2DFE, 0x2DFF, 0x200C, 
  0x200E, 0x200F
]);

/**
 * Checks if a character is a non-advancing combining mark.
 * Legacy fallback for environments without Intl.Segmenter.
 */
export const isNonAdvancing = (char: string): boolean => {
  const code = char.charCodeAt(0);
  return COMBINING_CODES.has(code);
};

/**
 * Clusters text into Render Runs. 
 * A run is a single base character followed by all its modifiers, 
 * or a complete grapheme cluster (like an emoji family).
 */
export const segmentRuns = (text: string): string[] => {
  // Ultra-Pro: Use Intl.Segmenter for perfect grapheme clusters (Emojis, Hindi, etc.)
  if (typeof Intl !== 'undefined' && (Intl as any).Segmenter) {
    const segmenter = new (Intl as any).Segmenter(undefined, { granularity: 'grapheme' });
    return Array.from(segmenter.segment(text)).map((s: any) => s.segment);
  }

  // Fallback Logic
  const runs: string[] = [];
  const chars = Array.from(text);
  
  for (let i = 0; i < chars.length; i++) {
    let run = chars[i];
    // Attach subsequent marks to the previous base character
    while (i + 1 < chars.length && isNonAdvancing(chars[i + 1])) {
      run += chars[++i];
    }
    runs.push(run);
  }
  return runs;
};
